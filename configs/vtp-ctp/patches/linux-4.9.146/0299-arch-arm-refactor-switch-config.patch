From 5ca01c0906f4b5ee55f9c2268e2a40ee199d56e8 Mon Sep 17 00:00:00 2001
From: Oliver Rohe <Oliver.Rohe@wago.com>
Date: Thu, 28 Mar 2019 10:20:34 +0100
Subject: [PATCH] arch: arm: refactor switch config

---
 arch/arm/boot/dts/am335x-pfc-750_8215.dts | 283 ++++++++++++------------------
 arch/arm/boot/dts/am3xxx-mv88e6321.dtsi   | 150 ++++++++++++++++
 2 files changed, 262 insertions(+), 171 deletions(-)
 create mode 100644 arch/arm/boot/dts/am3xxx-mv88e6321.dtsi

diff --git a/arch/arm/boot/dts/am335x-pfc-750_8215.dts b/arch/arm/boot/dts/am335x-pfc-750_8215.dts
index 5b89949..7a00675 100644
--- a/arch/arm/boot/dts/am335x-pfc-750_8215.dts
+++ b/arch/arm/boot/dts/am335x-pfc-750_8215.dts
@@ -8,54 +8,14 @@
 /dts-v1/;
 
 #include "am335x-pfc-750_821x.dtsi"
-#include "devconf.dtsi"
 #include "am335x-pfc-750_8208-dcan.dtsi"
+#include "am3xxx-mv88e6321.dtsi"
 #include "am335x-pfc-750_8215-tcam.dtsi"
+#include "devconf.dtsi"
 
 /{
 	model = "WAGO PFC200 750-8215";
 	compatible = "wago,am335x-pfc-750_821x-0182", "wago,am335x-pfc", "ti,am33xx";
-
-	swcfg_mv88e6321 {
-		compatible = "swcfg,mv88e6321";
-		status = "okay";
-
-		swcfg,mii-bus = <&davinci_mdio>;
-
-		swcfg,alias = "mv88e6321";
-		swcfg,cpu_port = <5>;
-		swcfg,ports = <7>;
-		swcfg,vlans = <1>;
-	};
-};
-
-&am33xx_pinmux {
-	pinctrl-names = "default";
-	pinctrl-0 = <&ethernet_irq_pins>;
-
-	davinci_mdio_default_pins: pinmux_davinci_mdio_default_pins {
-		pinctrl-single,pins = <
-			/* MDIO */
-			0x148 (PIN_INPUT_PULLUP | SLEWCTRL_FAST | MUX_MODE0)    /* mdio.mdio_data, SLEWCTRL_FAST?? */
-			0x14c (PIN_OUTPUT_PULLUP | MUX_MODE0)                   /* mdc.mdio_clk   */
-		>;
-	};
-
-	davinci_mdio_sleep_pins: pinmux_davinci_mdio_sleep_pins {
-		pinctrl-single,pins = <
-			/* MDIO reset value */
-			0x148 (PIN_INPUT_PULLDOWN | MUX_MODE7)
-			0x14c (PIN_INPUT_PULLDOWN | MUX_MODE7)
-		>;
-	};
-
-	ethernet_irq_pins: pinmux_ethernet_irq_pins {
-		pinctrl-single,pins = <
-			0x0dc (PIN_INPUT | MUX_MODE7) /* lcd_data15.gpio0_11 */ //MV88E6321-nINT
-			0x074 (PIN_INPUT | MUX_MODE7) /* gpmc_wpn.gpio0_31   */ //nINT-PHY2
-			0x110 (PIN_INPUT | MUX_MODE7) /* mii1_rxerr.gpio3_2  */ //nINT-PHY1
-		>;
-	};
 };
 
 &usb {
@@ -79,155 +39,136 @@
 	status = "okay";
 };
 
-&ksz8863 {
-	status = "disabled";
-};
-
 &wsysinit {
 	tty,rs232-485 = "nop";
 	profinet-capable;
 };
 
-&dsa {
-	status = "disabled";
-};
-
-&bitbang_mdio0 {
-	status = "disabled";
-};
-
-&davinci_mdio {
-	pinctrl-names = "default", "sleep";
-	pinctrl-0 = <&davinci_mdio_default_pins>;
-	pinctrl-1 = <&davinci_mdio_sleep_pins>;
-	status = "okay";
-
-	switch: switch@0 {
-		compatible = "marvell,mv88e6085";
+&switch {
+	compatible = "marvell,mv88e6085";
+	#address-cells = <1>;
+	#size-cells = <0>;
+	reg = <0>;
+	dsa,member = <0 0>;
+	reset-gpios = <&io_expander_70 4 GPIO_ACTIVE_LOW>;
+	phy-scan;
+	eeprom-length = <256>;
+	interrupt-parent = <&gpio0>;
+	interrupts = <11 IRQ_TYPE_LEVEL_LOW>;
+	interrupt-controller;
+	#interrupt-cells = <2>;
+	dsa,enable-on-boot;
+
+	eeprom = /bits/ 8 <0x20 0x80 0x09 0x5E 0x40 0x80 0x09 0x5E 0x01 0x7D 0x01 0x7D 0x01 0x7D 0x01 0x7D
+			   0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x60 0x94 0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x80 0x94
+			   0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x00 0x94 0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x20 0x94
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
+			   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF>;
+
+
+	mdio {
 		#address-cells = <1>;
 		#size-cells = <0>;
-		reg = <0>;
-		dsa,member = <0 0>;
-		reset-gpios = <&io_expander_70 4 GPIO_ACTIVE_LOW>;
-		phy-scan;
-		eeprom-length = <256>;
-		interrupt-parent = <&gpio0>;
-		interrupts = <11 IRQ_TYPE_LEVEL_LOW>;
-		interrupt-controller;
-		#interrupt-cells = <2>;
-		dsa,enable-on-boot;
-
-		eeprom = /bits/ 8 <0x20 0x80 0x09 0x5E 0x40 0x80 0x09 0x5E 0x01 0x7D 0x01 0x7D 0x01 0x7D 0x01 0x7D
-				   0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x60 0x94 0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x80 0x94
-				   0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x00 0x94 0xF9 0x7F 0x40 0x19 0xF8 0x7F 0x20 0x94
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF
-				   0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF>;
 
+		ext_phy0: ethernet-phy@0 {
+			compatible = "ethernet-phy-idD565.A401", "ethernet-phy-ieee802.3-c22";
+			reg = <0>;
+			max-speed = <100>;
+			interrupt-parent = <&gpio0>;
+			interrupts = <31 IRQ_TYPE_EDGE_FALLING>;
+		};
 
-		mdio {
-			#address-cells = <1>;
-			#size-cells = <0>;
+		ext_phy1: ethernet-phy@1 {
+			compatible = "ethernet-phy-idD565.A401", "ethernet-phy-ieee802.3-c22";
+			reg = <1>;
+			max-speed = <100>;
+			interrupt-parent = <&gpio3>;
+			interrupts = <2 IRQ_TYPE_EDGE_FALLING>;
+		};
 
-			ext_phy0: ethernet-phy@0 {
-				compatible = "ethernet-phy-idD565.A401", "ethernet-phy-ieee802.3-c22";
-				reg = <0>;
-				max-speed = <100>;
-				interrupt-parent = <&gpio0>;
-				interrupts = <31 IRQ_TYPE_EDGE_FALLING>;
-			};
+		int_phy3: ethernet-phy@3 {
+			compatible = "ethernet-phy-id0141.0C00", "ethernet-phy-ieee802.3-c22";
+			reg = <3>;
+			max-speed = <100>;
+			interrupt-parent = <&switch>;
+			interrupts = <3 IRQ_TYPE_LEVEL_HIGH>;
+			eee-broken-100tx;
+			eee-broken-1000t;
+		};
 
-			ext_phy1: ethernet-phy@1 {
-				compatible = "ethernet-phy-idD565.A401", "ethernet-phy-ieee802.3-c22";
-				reg = <1>;
-				max-speed = <100>;
-				interrupt-parent = <&gpio3>;
-				interrupts = <2 IRQ_TYPE_EDGE_FALLING>;
-			};
+		int_phy4: ethernet-phy@4 {
+			compatible = "ethernet-phy-id0141.0C00", "ethernet-phy-ieee802.3-c22";
+			reg = <4>;
+			max-speed = <100>;
+			interrupt-parent = <&switch>;
+			interrupts = <4 IRQ_TYPE_LEVEL_HIGH>;
+			eee-broken-100tx;
+			eee-broken-1000t;
+		};
+	};
 
-			int_phy3: ethernet-phy@3 {
-				compatible = "ethernet-phy-id0141.0C00", "ethernet-phy-ieee802.3-c22";
-				reg = <3>;
-				max-speed = <100>;
-				interrupt-parent = <&switch>;
-				interrupts = <3 IRQ_TYPE_LEVEL_HIGH>;
-				eee-broken-100tx;
-				eee-broken-1000t;
-			};
+	ports {
+		#address-cells = <1>;
+		#size-cells = <0>;
 
-			int_phy4: ethernet-phy@4 {
-				compatible = "ethernet-phy-id0141.0C00", "ethernet-phy-ieee802.3-c22";
-				reg = <4>;
-				max-speed = <100>;
-				interrupt-parent = <&switch>;
-				interrupts = <4 IRQ_TYPE_LEVEL_HIGH>;
-				eee-broken-100tx;
-				eee-broken-1000t;
-			};
+		port@0 {
+			reg = <0>;
+			label = "ethX1";
+			phy-handle = <&ext_phy0>;
+			phy-mode = "sgmii";
+			phy-external;
 		};
 
-		ports {
-			#address-cells = <1>;
-			#size-cells = <0>;
-
-			port@0 {
-				reg = <0>;
-				label = "ethX1";
-				phy-handle = <&ext_phy0>;
-				phy-mode = "sgmii";
-				phy-external;
-			};
+		port@1 {
+			reg = <1>;
+			label = "ethX2";
+			phy-handle = <&ext_phy1>;
+			phy-mode = "sgmii";
+			phy-external;
+		};
 
-			port@1 {
-				reg = <1>;
-				label = "ethX2";
-				phy-handle = <&ext_phy1>;
-				phy-mode = "sgmii";
-				phy-external;
+		/*port@2 {
+			reg = <2>;
+			label = "cpu";
+			ethernet = <&mac>;
+			fixed-link {
+				speed = <100>;
+				full-duplex;
 			};
+		};*/
 
-			/*port@2 {
-				reg = <2>;
-				label = "cpu";
-				ethernet = <&mac>;
-				fixed-link {
-					speed = <100>;
-					full-duplex;
-				};
-			};*/
-
-			port@3 {
-				reg = <3>;
-				label = "ethX11";
-				phy-handle = <&int_phy3>;
-				phy-mode = "rmii";
-			};
+		port@3 {
+			reg = <3>;
+			label = "ethX11";
+			phy-handle = <&int_phy3>;
+			phy-mode = "rmii";
+		};
 
-			port@4 {
-				reg = <4>;
-				label = "ethX12";
-				phy-handle = <&int_phy4>;
-				phy-mode = "rmii";
-			};
+		port@4 {
+			reg = <4>;
+			label = "ethX12";
+			phy-handle = <&int_phy4>;
+			phy-mode = "rmii";
+		};
 
-			port@6 {
-				reg = <6>;
-				label = "cpu";
-				ethernet = <&mac>;
-				fixed-link {
-					speed = <100>;
-					full-duplex;
-				};
+		port@6 {
+			reg = <6>;
+			label = "cpu";
+			ethernet = <&mac>;
+			fixed-link {
+				speed = <100>;
+				full-duplex;
 			};
 		};
 	};
diff --git a/arch/arm/boot/dts/am3xxx-mv88e6321.dtsi b/arch/arm/boot/dts/am3xxx-mv88e6321.dtsi
new file mode 100644
index 0000000..3e6a7e0
--- /dev/null
+++ b/arch/arm/boot/dts/am3xxx-mv88e6321.dtsi
@@ -0,0 +1,150 @@
+/*
+ * Copyright (C) 2011 Texas Instruments Incorporated - http://www.ti.com/
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+/ {
+	swcfg_mv88e6321: swcfg_mv88e6321 {
+		compatible = "swcfg,mv88e6321";
+		status = "okay";
+
+		swcfg,mii-bus = <&davinci_mdio>;
+
+		swcfg,alias = "mv88e6321";
+		swcfg,cpu_port = <5>;
+		swcfg,ports = <7>;
+		swcfg,vlans = <1>;
+	};
+};
+
+&am33xx_pinmux {
+	pinctrl-names = "default";
+	pinctrl-0 = <&ethernet_irq_pins>;
+
+	davinci_mdio_default_pins: pinmux_davinci_mdio_default_pins {
+		pinctrl-single,pins = <
+			/* MDIO */
+			0x148 (PIN_INPUT_PULLUP  | MUX_MODE0) /* mdio.mdio_data */
+			0x14c (PIN_OUTPUT_PULLUP | MUX_MODE0) /* mdc.mdio_clk   */
+		>;
+	};
+
+	davinci_mdio_sleep_pins: pinmux_davinci_mdio_sleep_pins {
+		pinctrl-single,pins = <
+			/* MDIO reset value */
+			0x148 (PIN_INPUT_PULLDOWN | MUX_MODE7)
+			0x14c (PIN_INPUT_PULLDOWN | MUX_MODE7)
+		>;
+	};
+
+	ethernet_irq_pins: pinmux_ethernet_irq_pins {
+		pinctrl-single,pins = <
+			0x0dc (PIN_INPUT | MUX_MODE7) /* lcd_data15.gpio0_11 */ //MV88E6321-nINT
+			0x074 (PIN_INPUT | MUX_MODE7) /* gpmc_wpn.gpio0_31   */ //nINT-PHY2
+			0x110 (PIN_INPUT | MUX_MODE7) /* mii1_rxerr.gpio3_2  */ //nINT-PHY1
+		>;
+	};
+};
+
+&ksz8863 {
+	status = "disabled";
+};
+
+&dsa {
+	status = "disabled";
+};
+
+&bitbang_mdio0 {
+	status = "disabled";
+};
+
+&davinci_mdio {
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&davinci_mdio_default_pins>;
+	pinctrl-1 = <&davinci_mdio_sleep_pins>;
+	status = "okay";
+
+	switch: switch@0 {
+		compatible = "marvell,mv88e6085";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		reg = <0>;
+		dsa,member = <0 0>;
+		reset-gpios = <&io_expander_70 4 GPIO_ACTIVE_LOW>;
+		phy-scan;
+		eeprom-length = <256>;
+		interrupt-parent = <&gpio0>;
+		interrupts = <11 IRQ_TYPE_LEVEL_LOW>;
+		interrupt-controller;
+		#interrupt-cells = <2>;
+		dsa,enable-on-boot;
+
+		mdio {
+			#address-cells = <1>;
+			#size-cells = <0>;
+
+			int_phy3: ethernet-phy@3 {
+				compatible = "ethernet-phy-id0141.0C00", "ethernet-phy-ieee802.3-c22";
+				reg = <3>;
+				max-speed = <100>;
+				interrupt-parent = <&switch>;
+				interrupts = <3 IRQ_TYPE_LEVEL_HIGH>;
+				eee-broken-100tx;
+				eee-broken-1000t;
+			};
+
+			int_phy4: ethernet-phy@4 {
+				compatible = "ethernet-phy-id0141.0C00", "ethernet-phy-ieee802.3-c22";
+				reg = <4>;
+				max-speed = <100>;
+				interrupt-parent = <&switch>;
+				interrupts = <4 IRQ_TYPE_LEVEL_HIGH>;
+				eee-broken-100tx;
+				eee-broken-1000t;
+			};
+		};
+
+		ports {
+			#address-cells = <1>;
+			#size-cells = <0>;
+
+			/*port@2 {
+				reg = <2>;
+				label = "cpu";
+				ethernet = <&mac>;
+				fixed-link {
+					speed = <100>;
+					full-duplex;
+				};
+			};*/
+
+			port@3 {
+				reg = <3>;
+				label = "ethX1";
+				phy-handle = <&int_phy3>;
+				phy-mode = "rmii";
+			};
+
+			port@4 {
+				reg = <4>;
+				label = "ethX2";
+				phy-handle = <&int_phy4>;
+				phy-mode = "rmii";
+			};
+
+			port@6 {
+				reg = <6>;
+				label = "cpu";
+				ethernet = <&mac>;
+				fixed-link {
+					speed = <100>;
+					full-duplex;
+				};
+			};
+		};
+	};
+};
+
-- 
2.7.4

